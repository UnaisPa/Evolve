<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">


<link rel="stylesheet" href="/stylesheet/cart.css">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
<!-- fontawesome -->
<link rel="stylesheet" href="/stylesheet/assets/css/all.min.css">
<!-- bootstrap -->
<link rel="stylesheet" href="/stylesheet/assets/bootstrap/css/bootstrap.min.css">
<!-- owl carousel -->
<link rel="stylesheet" href="/stylesheet/assets/css/owl.carousel.css">
<!-- magnific popup -->
<link rel="stylesheet" href="/stylesheet/assets/css/magnific-popup.css">
<!-- animate css -->
<link rel="stylesheet" href="/stylesheet/assets/css/animate.css">
<!-- mean menu css -->
<link rel="stylesheet" href="/stylesheet/assets/css/meanmenu.min.css">
<!-- main style -->
<link rel="stylesheet" href="/stylesheet/assets/css/main.css">
<!-- responsive -->
<link rel="stylesheet" href="/stylesheet/assets/css/responsive.css">
{{!-- sweet alert --}}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css">


<!--PreLoader-->
<div class="loader">
    <div class="loader-inner">
        <div class="circle"></div>
    </div>
</div>
<!--PreLoader Ends-->

<!-- header -->
<div class="top-header-area" id="sticker">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-sm-12 text-center">
                <div class="main-menu-wrap">
                    <!-- logo -->
                    <div class="site-logo">
                        <a href="/home">
                            <h3 style="color: #F28123;margin-top: 9px;">Evolve.</h3>
                            {{!-- <img src="stylesheet/assets/img/logo.png" alt=""> --}}
                        </a>
                    </div>
                    <!-- logo -->

                    <!-- menu start -->
                    <nav class="main-menu">
                        <ul>
                            <li><a href="/home">Home</a></li>
                            <li><a href="/shop">Shop</a></li>
                            {{#if verified}}<li><a href="/profile">Profile</a></li>
                            {{else}}<li><a href="/login">Login</a></li>{{/if}}
                            <li><a href="/contact">Contact</a></li>
                            <li><a href="/wishlist">Wishlist</a></li>
                            {{!-- <li><a href="shop.html">Shop</a>
                                <ul class="sub-menu">
                                    <li><a href="shop.html">Shop</a></li>
                                    <li><a href="checkout.html">Check Out</a></li>
                                    <li><a href="single-product.html">Single Product</a></li>
                                    <li><a href="cart.html">Cart</a></li>
                                </ul>
                            </li> --}}

                            <li>
                                <div class="header-icons">
                                    <a class="shopping-cart" href="/cart"><i style="color: #F28123;"
                                            class="fas fa-shopping-cart"></i></a>
                                    <a>
                                        <form action="/shop" method="get" style="margin-right:2%;">
                                            <div style="" class="input-group">
                                                <input id="searchBar" name="search" style="width: 130px;height: 40px;"
                                                    class="form-control" aria-describedby="button-addon2"
                                                    placeholder="Search" {{#if search}} value="{{search}}" {{/if}}>
                                                <button
                                                    style="border-color: rgb(223, 216, 216); border-left: white; background-color: white;"
                                                    class="btn " type="submit" id="button-addon2"><i id="searchbtn"
                                                        style="font-size: 20px;" class='bx bx-search'></i></button>
                                            </div>
                                        </form>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </nav>
                    
                    <div class="mobile-menu"></div>
                    <!-- menu end -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end header -->

<!-- search area -->
<div class="search-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <span class="close-btn"><i class="fas fa-window-close"></i></span>
                <div class="search-bar">
                    <div class="search-bar-tablecell">
                        <h3>Search For:</h3>
                        <input type="text" placeholder="Keywords">
                        <button type="submit">Search <i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end search area -->

{{!-- <section class="banner-section border-top border-bottom">
    <div class="text-center">
        <h2 style="padding-top:100px;">Shop</h2>
    </div>
</section> --}}
<!-- breadcrumb-section -->
<div class="breadcrumb-section breadcrumb-bg">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 text-center">
                <div class="breadcrumb-text">

                    <h1 style="font-weight: 700;">Cart</h1>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end breadcrumb section -->


<div class="modal fade" id="statusCartRemoveModal" tabindex="-1" role="dialog" data-bs-backdrop="static"
    data-bs-keyboard="false">

    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-body text-center p-lg-4">

                <i style="font-size: 50px; color:tan" class="bi bi-exclamation-circle-fill"></i>
                <h5 class="text mt-3" style="color: rgb(150, 121, 83);">Are you sure you want to
                    remove this product from your cart?</h5>

                <form action="/delete_item" method="post"><input id="alert-content" type="hidden" name="id"><button
                        type="submit" class="btn btn-sm mt-3 btn-danger confirmBtn">Remove</button></form>
                <button type="button" class="btn btn-sm mt-3 btn-primary" data-bs-dismiss="modal">Cancel</button>

            </div>
        </div>
    </div>
</div>

<button style="display: none;" type="button" class="btn btn-success m-1" data-bs-toggle="modal"
    data-bs-target="#statusCartRemoveModal" id="successCartRemoveButton">Success Modal</button>

{{#if notLogin}}
<section class="container">
    <div class="text-center errDiv">
        <img src="/Images/empty-cart.png">
        <h2>Your <span style="color:#B88E2F ;">Evolve</span> Cart is empty</h2>
        <div class="d-flex justify-content-center">
            <button class="btn  mx-1"><a style="text-decoration: none;color: #000;" href="/login">Sign in to your
                    account</a></button>
            <button class="btn  mx-1"><a style="text-decoration: none;color: #000;" href="/register">Create an account
                </a></button>
        </div>
    </div>
</section>
{{/if}}

{{#if verified}}
{{#if countIsZero}}
<section class="container mb-5">
    <div class="text-center errDiv">
        <img src="/Images/empty-cart.png">
        <h2>Your <span style="color:#B88E2F ;">Evolve</span> Cart is empty</h2>
        <div class="d-flex justify-content-center">
            <button class="btn  mx-1"><a style="text-decoration: none;color:black" href="/shop">Add Products to
                    Cart</a></button>

        </div>
    </div>
</section>
{{else}}

<section class="container">
    <div class="row cartItemMainDiv">
        <div style="" class="border cartItem col-md-8 col-sm-1">
            <table class="table table-borderless">
                <thead class="">
                    <tr>
                        <th style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">Img</th>
                        <th style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">Product</th>
                        <th style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">Price</th>
                        <th style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">Quantity</th>
                        <th id="subtotHead" style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">Sub
                            Total</th>
                        <th style=" background-color:rgb(244, 235, 225)" class="py-3" scope="col">action</th>
                    </tr>
                </thead>
                <tbody>

                    {{#each products}}
                    <tr class="p-5">
                        <td><img class="productImg" style="" src="/productimages/{{this.productId.image.[0]}}"></td>
                        <td class="pt-5" style="font-weight: 500;opacity: 70%;">{{this.productId.name}}</td>
                        <td class="pt-5 productPrice" style="font-weight: 500;opacity: 70%;">
                            Rs.{{this.productId.offerprice}}</td>
                        <td class="pt-5" style="font-weight: 500;opacity: 70%;">
                            <div class="d-flex counter">
                                <button data-product-id="{{this.productId._id}}" id=""
                                    class="btn border decrement">-</button>
                                <input style="width: 40px;" name="qty" readonly id="" class="btn border count"
                                    data-product-id="{{this.productId._id}}" value="{{this.quantity}}">
                                <button data-product-id="{{this.productId._id}}" type="submit"
                                    class="btn border increment">+</button>
                            </div>
                        </td>
                        <td class="pt-5">
                            <span style="" id="subTot" class="btn total total-price">{{this.total}}</span>
                            <button id="removeBTn" class="deleteBtn" data-product-id="{{this.productId._id}}"
                                style="font-weight: 500;opacity: 70%;border-style:none;background-color: white; "><i
                                    class="bi bi-trash3-fill"></i></button>
                        </td>
                        <td class="pt-5">
                            <button class="deleteBtn" data-product-id="{{this.productId._id}}"
                                style="font-weight: 500;opacity: 70%;border-style:none;background-color: white; "><i
                                    class="bi bi-trash3-fill"></i></button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
        <div style="" class=" payDiv col-md-4 col-sm-12 ">
            <div class="m-2  cartTotal border">
                <h4 class="text-center pb-5 pt-2">Cart Totals</h4>
                <div class="text-center">
                    <div class="d-flex justify-content-center p-2">
                        <p class="px-3">Total Items</p>
                        <p id="cartItemsCount" class="px-3">{{cartItemsCount}}</p>
                    </div>
                    <div class="d-flex justify-content-center p-2">
                        {{!-- <input type="hidden" value="{{cartTotal}}" id="inputTotal"> --}}
                        <p class="px-3" style="font-size: 25px;font-weight: 600;">Total</p>
                        <p style="font-size: 25px;font-weight: 600;color:#B88E2F">Rs.</p>
                        <p class="px-3 cartTotal" id="cartTotals"
                            style="font-size: 25px;font-weight: 600;color:#B88E2F">
                            {{cartTotal}}</p>
                    </div>
                    <form action="/checkout"><button class="btn checkBtn m-3 shadow">Check Out</button></form>
                </div>
            </div>
        </div>
    </div>
</section>
{{/if}}
{{/if}}

<div class="feature-div">
    <div class="container ">
        <div class=" row">
            <div class="col-3 pt-2">
                <div class="d-flex ">
                    <i style="font-size: 50px;" class="bi bi-trophy pt-1"></i>
                    <div class=" pt-3 px-2">
                        <h5 style="font-weight: 600;">High Quality</h5>
                        <p style="font-size: smaller;opacity: 60%;">crafted from top materials</p>
                    </div>
                </div>
            </div>
            <div class="col-3 pt-2">
                <div class="d-flex  px-3">
                    <i style="font-size: 50px;" class="bi bi-patch-check"></i>
                    <div class=" pt-2 px-2">
                        <h5 style="font-weight: 600;">Warranty Protection</h5>
                        <p style="font-size: smaller;opacity: 60%;">Over 2 years</p>
                    </div>
                </div>
            </div>
            <div class="col-3 pt-2">
                <div class="d-flex  px-3">
                    <i aria-colcount="pt-1" style="font-size: 50px;" class="bi bi-truck"></i>
                    <div class=" pt-3 px-2">
                        <h5 style="font-weight: 600;">Free Shipping</h5>
                        <p style="font-size: smaller;opacity: 60%;">Order over â‚¹499</p>
                    </div>
                </div>
            </div>
            <div class="col-3 pt-3">
                <div class="d-flex  px-3">
                    <i style="font-size: 50px;" class='bx bx-support'></i>
                    <div class=" pt-2 px-2">
                        <h5 style="font-weight: 600;">24/7 Support</h5>
                        <p style="font-size: smaller;opacity: 60%;">Dedicated support</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- footer -->
<div class="footer-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="footer-box about-widget">
                    <h2 class="widget-title">About us</h2>
                    <p>Evolve: Elevate your space with curated home decor and furniture. Explore a blend of style and
                        innovation for a sophisticated living experience.</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="footer-box get-in-touch">
                    <h2 class="widget-title">Get in Touch</h2>
                    <ul>
                        <li> GK Building , Bangalore 432</li>
                        <li>support@evolve.com</li>
                        <li>+91 667 8822 0909</li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="footer-box pages">
                    <h2 class="widget-title">Explore</h2>
                    <ul>
                        <li><a href="/home">Home</a></li>
                        <li><a href="/about">About</a></li>
                        <li><a href="/shop">Shop</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="footer-box subscribe">
                    <h2 class="widget-title">Subscribe</h2>
                    <p>Subscribe to our mailing list to get the latest updates.</p>
                    <form action="">
                        <input type="email" placeholder="Email">
                        <button type="submit"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end footer -->

<!-- copyright -->
<div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-12">
                <p>Copyrights &copy; 2023 - <a href="/home">Evolve</a>, All Rights
                    Reserved.</p>
            </div>
            <div class="col-lg-6 text-right col-md-12">
                <div class="social-icons">
                    <ul>
                        <li><a href="#" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
                        <li><a href="#" target="_blank"><i class="fab fa-twitter"></i></a></li>
                        <li><a href="#" target="_blank"><i class="fab fa-instagram"></i></a></li>
                        <li><a href="#" target="_blank"><i class="fab fa-linkedin"></i></a></li>
                        <li><a href="#" target="_blank"><i class="fab fa-dribbble"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end copyright -->

<!-- jquery -->
<script src="/stylesheet/assets/js/jquery-1.11.3.min.js"></script>
<!-- bootstrap -->
<script src="/stylesheet/assets/bootstrap/js/bootstrap.min.js"></script>
<!-- count down -->
<script src="/stylesheet/assets/js/jquery.countdown.js"></script>
<!-- isotope -->
<script src="/stylesheet/assets/js/jquery.isotope-3.0.6.min.js"></script>
<!-- waypoints -->
<script src="/stylesheet/assets/js/waypoints.js"></script>
<!-- owl carousel -->
<script src="/stylesheet/assets/js/owl.carousel.min.js"></script>
<!-- magnific popup -->
<script src="/stylesheet/assets/js/jquery.magnific-popup.min.js"></script>
<!-- mean menu -->
<script src="/stylesheet/assets/js/jquery.meanmenu.min.js"></script>
<!-- sticker js -->
<script src="/stylesheet/assets/js/sticker.js"></script>
<!-- main js -->
<script src="/stylesheet/assets/js/main.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script lang="javaScript">
    async function changeQuantity(productId, value, currentValue) {
        const data = {
            proId: productId,
            count: value,
            currentValue: currentValue
        };

        const response = await fetch('/update-quantity', {
            method: 'post',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'error') {
            Swal.fire({
                title: result.message,
                icon: 'error',
                showCancelButton: false,
                timer: 1500
            })
            return { status: 'error' }
        }
        document.getElementById('cartItemsCount').textContent = result.cartItemsCount;
        document.getElementById('cartTotals').textContent = result.cartItemsTotal

        return { status: 'success' }
    }
    // Function to calculate and update the cart total
    /*async function changeQuantity(productId, value, currentValue) {
        const data = {
            proId: productId,
            count: value,
            currentValue: currentValue
        };
        $.ajax({
            type: "POST",
            url: "/update-quantity", // Your server route for adding items to the cart
            data: data
                success: function (data) {
                const result = await data.json();
                if (result.status === 'error') {
                    Swal.fire({
                        title: result.message,
                        icon: 'error',
                        showCancelButton: false,
                        timer: 1500
                    })
                    return { status: 'error' }
                }
                document.getElementById('cartItemsCount').textContent = result.cartItemsCount;
                return { status: 'success' }
                },
            error: function (error) {
                console.error(error);
            }
        });
    }
    */

    // Function to increase the quantity of a product
    async function increaseQuantity(inputField, productId, value) {
        const currentValue = parseInt(inputField.value);
        if (!isNaN(currentValue)) {
            console.log("increase")
            const response = await changeQuantity(productId, value, currentValue + 1);
            if (response && response.status === 'success') {
                inputField.value = currentValue + 1;
                updateQuantity(inputField);
                //updateCart(); // Update the cart total when the quantity changes
            }
            // console.log(currentValue)
        }
    }

    // Function to decrease the quantity of a product
    async function decreaseQuantity(inputField, productId, value) {
        // console.log(productId)
        const currentValue = parseInt(inputField.value);
        if (!isNaN(currentValue) && currentValue > 1) {
            const response = await changeQuantity(productId, value, currentValue - 1);
            if (response && response.status === 'success') {
                inputField.value = currentValue - 1;
                updateQuantity(inputField);
                //updateCart(); // Update the cart total when the quantity changes
            }
            // console.log(currentValue)
        }
    }

    // Function to update the quantity and total price
    function updateQuantity(inputField) {
        const container = inputField.closest('tr'); // Changed this line to get the closest table row
        const quantity = parseInt(inputField.value);
        const productPrice = parseInt(container.querySelector('.productPrice').textContent.replace(/\D/g, '')); // Remove non-numeric characters
        const totalPriceElement = container.querySelector('.total-price');

        if (!isNaN(quantity) && !isNaN(productPrice) && totalPriceElement) {
            const newTotal = quantity * productPrice;
            totalPriceElement.textContent = newTotal.toLocaleString('en-IN'); // Format as currency
        }
    }


    // Function to update the cart after quantity changes
    function updateCart() {
        updateCartTotal(); // Update the cart total
    }

    function updateCartTotal() {
        const productRows = document.querySelectorAll('tbody tr'); // Get all product rows
        let cartTotal = 0;

        // Loop through each product row and calculate the total
        productRows.forEach(function (row) {
            const quantityInput = row.querySelector('.count');
            const productPriceElement = row.querySelector('.productPrice');

            if (quantityInput && productPriceElement) {
                const quantity = parseInt(quantityInput.value);
                const productPrice = parseInt(productPriceElement.textContent.replace(/\D/g, '')); // Remove non-numeric characters

                if (!isNaN(quantity) && !isNaN(productPrice)) {

                    cartTotal += quantity * productPrice;

                }
            }
        });

        // Update the "cartTotal" element with the new total
        const cartTotalElement = document.querySelector('.cartTotal');
        if (cartTotalElement) {
            cartTotalElement.textContent = cartTotal.toLocaleString('en-IN'); // Format as currency
        }
    }

    /*document.querySelectorAll('.counter').forEach(function (container) {
            //const inputField = container.querySelector('input[name="qty"]');
            const inputField = container.querySelector('.count');
            const increaseButton = container.querySelector('.increment');
            const decreaseButton = container.querySelector('.decrement');
            const productId = inputField.dataset.productId;

            increaseButton.addEventListener('click', function () {
                increaseQuantity(inputField, productId, 1);
            });

            decreaseButton.addEventListener('click', function () {
                decreaseQuantity(inputField, productId, -1);
            });
        });*/

    document.querySelectorAll('.counter').forEach(counter => {
        const decrementButton = counter.querySelector('.decrement');
        const incrementButton = counter.querySelector('.increment');
        const inputField = counter.querySelector('.count');
        const productId = inputField.dataset.productId;

        decrementButton.addEventListener('click', () => {
            decreaseQuantity(inputField, productId, -1);
            console.log("ITs workingggg")
        })

        incrementButton.addEventListener('click', () => {
            increaseQuantity(inputField, productId, 1);
        })
    })


    //Remove Item from cart
    const deleteBtn = document.querySelectorAll('.deleteBtn');
    deleteBtn.forEach(button => {

        button.addEventListener('click', (e) => {
            e.preventDefault();
            //const productId = $('.deleteBtn').data("product-id");
            const productId = button.dataset.productId;
            console.log(productId)
            if (productId) {
                const response = Swal.fire({
                    title: "Are you Sure ",
                    text: "To Remove Product from Cart",
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#990f0f',
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No !'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            type: "POST",
                            url: "/remove_item", // Your server route for adding items to the cart
                            data: { productId },
                            success: function (data) {
                                //const results = data.json();
                                if (data.status == "success") {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Item Removed',
                                        showConfirmButton: false,
                                        timer: 2000
                                    })
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000)
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: result.message,
                                        showConfirmButton: false,
                                        timer: 1500
                                    })
                                }

                            },
                            error: function (error) {
                                console.error(error);
                            }
                        });
                    }
                })

            }
        })
    })



</script>